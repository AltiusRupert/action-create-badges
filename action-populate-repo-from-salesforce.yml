name: Populate Github repository from Salesforce org

# Salesforce login parameters.
# Login with :
# - either salesforce_url, salesforce_username, salesforce_password
# - or with salesforce_accesstoken
# - or with salesforce_authurl

inputs:
  salesforce_url:
    description: Salesforce org url (best with mydomain.my.salesforce.com, mydomain-dev-ed.my.salesforce ou mydomain--mysandbvox.my.salesforce.com
    required: false
  salesforce_username:
    description: Salesforce org admin username
    required: false
  salesforce_password:
    description: Salesforce org admin password, concatenated with security token
    required: false

runs:
  using: "composite"
    runs-on: ubuntu-latest
    name: Retrieve code and check into repository
    container: salesforce/salesforcedx:7.75.1-full
    steps:        
        
      #########################################################################################################
      # Get SFDX installed correctly, and authenticated

      - name: Add SFDX Powerkit Plugin for login with username and password
        if: inputs.salesforce_password != ''
        shell: bash
        run: |
          echo 'y' | sfdx plugins:install sfpowerkit

      - name: Authenticate with SFDX using username and password, including security token
        if: inputs.salesforce_password != ''
        shell: bash
        run: |
          sfdx sfpowerkit:auth:login -r ${{ secrets.SALESFORCE_URL }} -u ${{ secrets.SALESFORCE_USERNAME }} -p ${{ secrets.SALESFORCE_PASSWORD }} -a checkout
          sfdx force:config:set defaultusername=checkout        


      #########################################################################################################
      # Get latest Salesforce metadata

      - name: Retrieve source from Salesforce organization
        shell: bash
        run: |
          sfdx force:source:retrieve -x ./manifest/package.xml
          cd ./force-app/main/default/staticresources
          find . -name .git -type d -exec rm -rf {} \; || true
          cd ../../../../
          
